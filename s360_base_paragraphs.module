<?php

/**
 * @file
 * s360_base_paragraphs.module
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\views\Views;
use Drupal\webform\Entity\Webform;

/**
 * Implements hook_help().
 */
function s360_base_paragraphs_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.s360_base_paragraphs':
      $paragraphs = [
        'cta_link' => t('CTA Link'),
        'curated_content' => t('Curated Content'),
        'document_list' => t('Document List'),
        'embed_code' => t('Embed Code'),
        'faq' => t('FAQ'),
        'html_content' => t('HTML Content'),
        'image' => t('Image'),
        'in_this_section' => t('In this Section'),
        'link_list' => t('Link List'),
        'placeholder' => t('Placeholder'),
        'video' => t('Video'),
        'view_block' => t('View Block'),
        'webform' => t('Webform'),
      ];

      $output = '';

      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('This module adds commonly used paragraphs types.') . '</p>';

      $output .= '<h3>' . t('Paragraph types') . '</h3>';
      $output .= '<dl>';

      foreach ($paragraphs as $paragraph_key => $paragraph_label) {
        $paragraph_config = \Drupal::config("paragraphs.paragraphs_type.$paragraph_key");

        // The paragraph is still configured (not deleted).
        if (!empty($paragraph_config->getRawData())) {
          $output .= '<dt><strong>' . $paragraph_config->get('label') . '</strong></dt>';
          $output .= '<dd>' . $paragraph_config->get('description') . '</dd>';
        }
        // The paragraph was deleted.
        else {
          $output .= "<dt><strong>$paragraph_label</strong></dt>";
          $output .= "<dd>This paragraph was removed.</dd>";
        }
      }

      $output .= '</dl>';

      return $output;
  }
}

/**
 * Implements hook_preprocess_paragraph() for view_block.
 */
function s360_base_paragraphs_preprocess_paragraph__view_block(&$variables) {
  if (_s360_base_paragraphs_is_admin_route()) {
    /** @var \Drupal\paragraphs\Entity\Paragraph $paragraph */
    $paragraph = $variables['paragraph'];

    $field_view = $paragraph?->field_view?->getValue();

    // No field_view value, do nothing.
    if (!$field_view) {
      return;
    }

    $field_view = reset($field_view);

    // Check if required values exist to avoid unnecessary processing.
    if (empty($field_view['target_id']) || empty($field_view['display_id'])) {
      return;
    }

    /** @var \Drupal\views\ViewExecutable $view */
    $view = Views::getView($field_view['target_id']);

    if ($view) {
      $view->setDisplay($field_view['display_id']);
      $view_display = $view->getDisplay();
      $view_display_title = $view_display->display['display_title'] ?? $field_view['display_id'];
      $field_item_text = $view->storage->label() . " ($view_display_title)";
    }
    else {
      $field_item_text = 'Problem loading the view.';
    }

    $variables['content']['field_view'] = [
      '#type' => 'html_tag',
      '#tag' => 'div',
      '#attributes' => [
        'class' => [
          'field',
          'field--name-field-view',
          'field--type-string',
          'field--label-inline',
        ],
      ],
      'child' => [
        [
          '#type' => 'html_tag',
          '#tag' => 'div',
          '#value' => 'View',
          '#attributes' => [
            'class' => 'field__label',
          ],
        ],
        [
          '#type' => 'html_tag',
          '#tag' => 'div',
          '#value' => $field_item_text,
          '#attributes' => [
            'class' => 'field__item',
          ],
        ],
      ],
    ];
  }
}

/**
 * Implements hook_preprocess_paragraph() for webform.
 */
function s360_base_paragraphs_preprocess_paragraph__webform(&$variables) {
  if (_s360_base_paragraphs_is_admin_route()) {
    /** @var \Drupal\paragraphs\Entity\Paragraph $paragraph */
    $paragraph = $variables['paragraph'];

    $field_webform = $paragraph?->field_webform?->getValue();

    // No field_webform value, do nothing.
    if (!$field_webform) {
      return;
    }

    $field_webform = reset($field_webform);

    // Check if target_id exists before loading.
    if (empty($field_webform['target_id'])) {
      return;
    }

    /** @var \Drupal\webform\Entity\Webform $webform */
    $webform = Webform::load($field_webform['target_id']);

    // Add access check for webform.
    if ($webform && !$webform->access('view')) {
      $webform = NULL;
    }

    $variables['content']['field_webform'] = [
      '#type' => 'html_tag',
      '#tag' => 'div',
      '#attributes' => [
        'class' => [
          'field',
          'field--name-field-webform',
          'field--type-string',
          'field--label-inline',
        ],
      ],
      'child' => [
        [
          '#type' => 'html_tag',
          '#tag' => 'div',
          '#value' => 'Webform',
          '#attributes' => [
            'class' => 'field__label',
          ],
        ],
        [
          '#type' => 'html_tag',
          '#tag' => 'div',
          '#value' => $webform?->label() ?? 'Problem loading the webform.',
          '#attributes' => [
            'class' => 'field__item',
          ],
        ],
      ],
    ];
  }
}

/**
 * Checks the route name to see if it's an "admin route".
 *
 * @return bool
 *   Returns true if the current route is found in the array, false otherwise.
 */
function _s360_base_paragraphs_is_admin_route() {
  $admin_paths = [
    'node.add',
    'entity.node.edit_form',
    'entity.group.edit_form',
    'layout_paragraphs.*',
  ];

  $url = Drupal::routeMatch()->getRouteName();

  $result = array_filter($admin_paths, function ($v) use ($url) {
    return preg_match('~' . $v . '~', $url);
  });

  return count($result) ? TRUE : FALSE;
}
