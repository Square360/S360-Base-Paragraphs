<?php

/**
 * @file
 * s360_base_paragraphs.module
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Component\Utility\Html;

/**
 * Implements hook_help().
 */
function s360_base_paragraphs_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.s360_base_paragraphs':
      $output = '';

      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('This module adds commonly used paragraphs types.') . '</p>';

      $output .= '<p>&nbsp;</p>';

      $output .= '<h3>' . t('Paragraph types') . '</h3>';
      $output .= '<ul>';
      $output .= '<li>' . t('Header') . '</li>';
      $output .= '<li>' . t('HTML Content') . '</li>';
      $output .= '<li>' . t('Image') . '</li>';
      $output .= '<li>' . t('Video') . '</li>';
      $output .= '<li>' . t('View Block') . '</li>';
      $output .= '<li>' . t('Webform') . '</li>';
      $output .= '</ul>';

      return $output;
  }
}

/**
 * Implements hook_preprocess_paragraph().
 */
function s360_base_paragraphs_preprocess_paragraph(&$variables) {
  $elements = $variables['elements'];

  if (isset($elements['#paragraph'])) {
    /** @var \Drupal\paragraph\Entity\Paragraph $paragraph */
    $paragraph = $elements['#paragraph'];
    $paragraph_bundle = $paragraph->bundle();
    $paragraph_bundle_safe = Html::getClass($paragraph_bundle);

    $variables['attributes']['class'] = [];
    $variables['attributes']['id'] = 'paragraph-' . $paragraph_bundle_safe . '-' . $paragraph->id();
    $variables['attributes']['data-js'] = $paragraph_bundle_safe;
  }
}

/**
 * Implements hook_preprocess_paragraph() for view_block.
 */
function s360_base_paragraphs_preprocess_paragraph__view_block(&$variables) {
  if (\Drupal::service('router.admin_context')->isAdminRoute()) {
    if (isset($variables['paragraph'])) {
      /** @var \Drupal\paragraphs\Entity\Paragraph $paragraph */
      $paragraph = $variables['paragraph'];

      $field_view = $paragraph->get('field_view')->first()->getValue();
      $view_target_id = $field_view['target_id'];
      $view_display_id = $field_view['display_id'];
      $view = \Drupal\views\Views::getView($view_target_id);

      $view->setDisplay($view_display_id);
      $display_obj = $view->getDisplay();
      $display_name = $display_obj->display['display_title'];

      $variables['content']['field_view'] = [
        '#type' => 'html_tag',
        '#tag' => 'div',
        '#attributes' => [
          'class' => 'field field--name-field-view field--type-string field--label-inline',
        ],
        'child' => [
          [
            '#type' => 'html_tag',
            '#tag' => 'div',
            '#value' => 'View',
            '#attributes' => [
              'class' => 'field__label'
            ],
          ],
          [
            '#type' => 'html_tag',
            '#tag' => 'div',
            '#value' => $view->storage->label() . ' (' . $display_name . ')',
            '#attributes' => [
              'class' => 'field__item'
            ],
          ],
        ],
      ];
    }
  }
}

/**
 * Implements hook_preprocess_paragraph() for webform.
 */
function kmha_mediteran_preprocess_paragraph__webform(&$variables) {
  if (\Drupal::service('router.admin_context')->isAdminRoute()) {
    if (isset($variables['paragraph'])) {
      /** @var \Drupal\paragraphs\Entity\Paragraph $paragraph */
      $paragraph = $variables['paragraph'];

      $field_webform = $paragraph->get('field_webform')->first()->getValue();
      $wf_target_id = $field_webform['target_id'];
      $wf = \Drupal\webform\Entity\Webform::load($wf_target_id);

      $variables['content']['field_webform'] = [
        '#type' => 'html_tag',
        '#tag' => 'div',
        '#attributes' => [
          'class' => 'field field--name-field-webform field--type-string field--label-inline',
        ],
        'child' => [
          [
            '#type' => 'html_tag',
            '#tag' => 'div',
            '#value' => 'Webform',
            '#attributes' => [
              'class' => 'field__label'
            ],
          ],
          [
            '#type' => 'html_tag',
            '#tag' => 'div',
            '#value' => $wf->label(),
            '#attributes' => [
              'class' => 'field__item'
            ],
          ],
        ],
      ];
    }
  }
}
