<?php

/**
 * @file
 * s360_base_paragraphs.module
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Component\Utility\Html;

/**
 * Implements hook_help().
 */
function s360_base_paragraphs_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.s360_base_paragraphs':
      $paragraphs = [
        'header' => t('Header'),
        'html_content' => t('HTML Content'),
        'image' => t('Image'),
        'link_list' => t('Link List'),
        'placeholder' => t('Placeholder'),
        'video' => t('Video'),
        'view_block' => t('View Block'),
        'webform' => t('Webform'),
      ];

      $output = '';

      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('This module adds commonly used paragraphs types.') . '</p>';

      $output .= '<p>&nbsp;</p>';

      $output .= '<h3>' . t('Paragraph types') . '</h3>';
      $output .= '<dl>';

      foreach ($paragraphs as $paragraph_key => $paragraph_label) {
        $paragraph_config = \Drupal::config("paragraphs.paragraphs_type.$paragraph_key");

        if (!empty($paragraph_config->getRawData())) {
          $output .= '<dt><strong>' . $paragraph_config->get('label') . '</strong></dt>';
          $output .= '<dd>' . $paragraph_config->get('description') . '</dd>';
        }
        else {
          $output .= "<dt><strong>$paragraph_label</strong></dt>";
          $output .= "<dd>This paragraph was removed</dd>";
        }
      }

      $output .= '</dl>';

      return $output;
  }
}

/**
 * Implements hook_preprocess_paragraph().
 */
function s360_base_paragraphs_preprocess_paragraph(&$variables) {
  $elements = $variables['elements'];

  if (isset($elements['#paragraph'])) {
    /** @var \Drupal\paragraph\Entity\Paragraph $paragraph */
    $paragraph = $elements['#paragraph'];
    $paragraph_bundle = $paragraph->bundle();
    $paragraph_bundle_safe = Html::getClass($paragraph_bundle);

    $variables['attributes']['class'] = [];
    $variables['attributes']['id'] = 'paragraph-' . $paragraph_bundle_safe . '-' . $paragraph->id();
    $variables['attributes']['data-js'] = $paragraph_bundle_safe;
  }
}

/**
 * Implements hook_preprocess_paragraph() for view_block.
 */
function s360_base_paragraphs_preprocess_paragraph__view_block(&$variables) {
  if (\Drupal::service('router.admin_context')->isAdminRoute()) {
    if (isset($variables['paragraph'])) {
      /** @var \Drupal\paragraphs\Entity\Paragraph $paragraph */
      $paragraph = $variables['paragraph'];

      if ($paragraph->hasField('field_view') && $paragraph->get('field_view')->count()) {
        $field_view = $paragraph->get('field_view')->first()->getValue();
        $view_target_id = $field_view['target_id'];
        $view_display_id = $field_view['display_id'];

        /** @var \Drupal\views\ViewExecutable $view */
        $view = \Drupal\views\Views::getView($view_target_id);

        if ($view) {
          $view->setDisplay($view_display_id);
          $display_obj = $view->getDisplay();
          $display_name = $display_obj->display['display_title'];
          $field_item_text = $view->storage->label() . ' (' . $display_name . ')';
        }
        else {
          $field_item_text = 'Problem loading the view.';
        }

        $variables['content']['field_view'] = [
          '#type' => 'html_tag',
          '#tag' => 'div',
          '#attributes' => [
            'class' => [
              'field',
              'field--name-field-view',
              'field--type-string',
              'field--label-inline',
            ],
          ],
          'child' => [
            [
              '#type' => 'html_tag',
              '#tag' => 'div',
              '#value' => 'View',
              '#attributes' => [
                'class' => 'field__label'
              ],
            ],
            [
              '#type' => 'html_tag',
              '#tag' => 'div',
              '#value' => $field_item_text,
              '#attributes' => [
                'class' => 'field__item'
              ],
            ],
          ],
        ];
      }
    }
  }
}

/**
 * Implements hook_preprocess_paragraph() for webform.
 */
function s360_base_paragraphs_preprocess_paragraph__webform(&$variables) {
  if (\Drupal::service('router.admin_context')->isAdminRoute()) {
    if (isset($variables['paragraph'])) {
      /** @var \Drupal\paragraphs\Entity\Paragraph $paragraph */
      $paragraph = $variables['paragraph'];

      if ($paragraph->hasField('field_webform') && $paragraph->get('field_webform')->count()) {
        $field_webform = $paragraph->get('field_webform')->first()->getValue();
        $wf_target_id = $field_webform['target_id'];

        /** @var \Drupal\webform\Entity\Webform $wf */
        $wf = \Drupal\webform\Entity\Webform::load($wf_target_id);

        if ($wf) {
          $field_item_text = $wf->label() . ($wf->getDescription()
            ? '<br> ' . $wf->getDescription()
            : '');
        }
        else {
          $field_item_text = 'Problem loading the webform.';
        }

        $variables['content']['field_webform'] = [
          '#type' => 'html_tag',
          '#tag' => 'div',
          '#attributes' => [
            'class' => [
              'field',
              'field--name-field-webform',
              'field--type-string',
              'field--label-inline',
            ],
          ],
          'child' => [
            [
              '#type' => 'html_tag',
              '#tag' => 'div',
              '#value' => 'Webform',
              '#attributes' => [
                'class' => 'field__label'
              ],
            ],
            [
              '#type' => 'html_tag',
              '#tag' => 'div',
              '#value' => $field_item_text,
              '#attributes' => [
                'class' => 'field__item'
              ],
            ],
          ],
        ];
      }
    }
  }
}

/**
 * Implements hook_preprocess_paragraph() for curated_content.
 */
function s360_base_paragraphs_preprocess_paragraph__curated_content(&$variables) {
  $entity_type_manager = \Drupal::entityTypeManager();

  /** @var \Drupal\paragraphs\Entity\Paragraph $paragraph */
  $paragraph = $variables['paragraph'];

  if ($paragraph->hasField('field_ern_content')) {
    $field_ern_content = $paragraph->get('field_ern_content');

    if ($field_ern_content->count()) {
      $node_id = $field_ern_content->first()->getString();
    }
  }

  if ($paragraph->hasField('field_view_mode')) {
    $field_view_mode = $paragraph->get('field_view_mode');

    if ($field_view_mode->count()) {
      $view_mode = $field_view_mode->first()->getString();
    }
  }

  if ($field_ern_content && $field_view_mode) {
    /** @var \Drupal\node\Entity\Node $node */
    $node = $entity_type_manager->getStorage('node')->load($node_id);

    // Make sure it's a valid node and we have the proper access to view it.
    if ($node && $node->access('view')) {
      $render_controller = $entity_type_manager->getViewBuilder('node');
      $variables['curated_node'] = $render_controller->view($node, $view_mode);
    }
  }
  else {
    $variables['curated_node'] = '';
  }
}

/**
 * Implements hook_modules_installed().
 */
function s360_base_paragraphs_modules_installed() {
  $config = \Drupal::service('config.factory')->getEditable('paragraphs.paragraphs_type.from_library');

  $config->set('icon_uuid', '77cb48d9-4997-4c8b-beb7-8879ceb53698')->save();
  $config->set('icon_default', 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz48c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmlld0JveD0iMCAwIDUxMiA1MTIiPjxnIGlkPSJTcXVhcmVfRnJhbWUiPjxnPjxyZWN0IHg9IjEwIiB5PSIxMCIgd2lkdGg9IjQ5MiIgaGVpZ2h0PSI0OTIiIHJ4PSI3MCIgcnk9IjcwIiBzdHlsZT0iZmlsbDojZmZmOyIvPjxwYXRoIGQ9Ik00MzIsMjBjMTUuOTQsMCwzMC45OCw2LjI3LDQyLjM2LDE3LjY0LDExLjM4LDExLjM4LDE3LjY0LDI2LjQyLDE3LjY0LDQyLjM2VjQzMmMwLDE1Ljk0LTYuMjcsMzAuOTgtMTcuNjQsNDIuMzYtMTEuMzgsMTEuMzgtMjYuNDIsMTcuNjQtNDIuMzYsMTcuNjRIODBjLTE1Ljk0LDAtMzAuOTgtNi4yNy00Mi4zNi0xNy42NC0xMS4zOC0xMS4zOC0xNy42NC0yNi40Mi0xNy42NC00Mi4zNlY4MGMwLTE1Ljk0LDYuMjctMzAuOTgsMTcuNjQtNDIuMzYsMTEuMzgtMTEuMzgsMjYuNDItMTcuNjQsNDIuMzYtMTcuNjRINDMyTTQzMiwwSDgwQzM2LDAsMCwzNiwwLDgwVjQzMmMwLDQ0LDM2LDgwLDgwLDgwSDQzMmM0NCwwLDgwLTM2LDgwLTgwVjgwQzUxMiwzNiw0NzYsMCw0MzIsMGgwWiIvPjwvZz48L2c+PGcgaWQ9ImxpYnJhcnkiPjxwYXRoIGQ9Ik00MTAuNjMsMTMzLjRoLTExMS4yYy0yNS4zNSwwLTM3LjU5LDEzLjM2LTQzLjQzLDI0Ljc2LTUuODUtMTEuNDEtMTguMDgtMjQuNzYtNDMuNDMtMjQuNzZIMTAxLjM2Yy0zLjUxLDAtNi4zNiwyLjg0LTYuMzYsNi4zNnYyMzIuNDljMCwzLjUxLDIuODQsNi4zNiw2LjM2LDYuMzZINDEwLjYzYzMuNTEsMCw2LjM3LTIuODQsNi4zNy02LjM2VjEzOS43NmMwLTMuNTItMi44NS02LjM2LTYuMzctNi4zNlptLTE5NC44NywyMDQuNDNIMTA3LjcxVjE0Ni4xaDMxLjc2djEwNi43MWwyNC4zNy0zMS41MiwyNC4zNiwzMS41MnYtMTA2LjcxaDI0LjM3YzM1Ljc5LDAsMzcuMDQsMzMuMywzNy4wNywzNy4wN3YxNjQuNDljLTYuNjktNS41OS0xNi43NS05LjgzLTMzLjg4LTkuODNabTE4OC41MywwaC0xMDguMDVjLTE3LjEzLDAtMjcuMTksNC4yNS0zMy44OSw5Ljg0VjE4My4yYy4wMy0zLjc5LDEuMjctMzcuMDksMzcuMDctMzcuMDloMTA0Ljg2djE5MS43MWgwWiIvPjwvZz48L3N2Zz4=')->save();
  $config->set('description', 'Place reusable paragraphs on a page.')->save();
}
